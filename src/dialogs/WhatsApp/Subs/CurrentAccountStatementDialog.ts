// Node modules.
import {
	IDialog,
	ServiceWhatsappBaseDialog,
	TBaseDialogCtor,
} from 'cxperium-bot-engine';
import { TButton } from 'cxperium-bot-engine/lib/types/whatsapp/message';
import {
	getCurrentAccountStatement,
	getUserInformation,
} from '../../../helpers/SQLConnection';
import { createPdf, removePdfFromPath } from '../../../helpers/PDFCreator';

export default class extends ServiceWhatsappBaseDialog implements IDialog {
	constructor(data: TBaseDialogCtor) {
		super(data);
	}

	async runDialog(): Promise<void> {
		const customerId = await this.conversation.getCache('customerId');
		const sqlResult = await getCurrentAccountStatement(customerId);
		const userInformation = await getUserInformation(customerId);
		sqlResult.forEach((x) => {
			x.Mƒ∞KTAR = formatNumberToLocale(x.Mƒ∞KTAR);
			x.TUTAR = formatNumberToLocale(x.TUTAR);
			x.√ñDENEN = formatNumberToLocale(x.√ñDENEN);
			x.KALAN = formatNumberToLocale(x.KALAN);
		});
		console.table(sqlResult);
		const result = await createPdf(
			sqlResult,
			userInformation,
			`cari-hesap-ekstresi.pdf`,
			1,
		);

		if (result.status) {
			const button: TButton[] = [
				{
					id: '#main_menu',
					title: 'üè† Ana Men√º',
				},
			];
			await this.sendButtonMessage(
				'üçÉ Bilgilendirme Mesajƒ±',
				'üçÉ Vega Gƒ±da A.≈û.',
				`Sayƒ±n *${this.contact.userProfileName}*, belgeniz hazƒ±rlanmaktadƒ±r. Bu s√ºre√ßte *Ana Men√ºye* a≈üaƒüƒ±daki buton ile devam edebilir diƒüer i≈ülemlerinizi yapabilirsiniz.`,
				button,
			);
			await new Promise((r) => setTimeout(r, 3000));
		} else {
			await this.sendMessage(
				'Sistemsel bir problem mevcuttur. L√ºtfen bizimle ileti≈üime ge√ßiniz.',
			);
			return;
		}

		const url = `${process.env.PUBLIC_URL}cari-hesap-ekstresi.pdf`;
		await this.sendDocumentWithUrl('Cari Hesap Ekstresi', url);
		// await removePdfFromPath(result.outputPath);
	}
}

function formatNumberToLocale(numberString) {
	const number = parseFloat(numberString);
	const formattedNumber = number.toLocaleString('tr-TR', {
		minimumFractionDigits: 2,
		maximumFractionDigits: 2,
	});

	return formattedNumber;
}
